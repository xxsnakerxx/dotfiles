name: Test

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: macos-26

    steps:
      - name: Clean up installed software
        shell: zsh {0}
        run: |
          brew uninstall --ignore-dependencies --force $(brew list --formula)
          brew uninstall --cask --force $(brew list --cask)
          brew cleanup --prune-prefix
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clone repo to home (simulate user setup)
        shell: zsh {0}
        run: |
          cp -R "$GITHUB_WORKSPACE" ~/.dotfiles

      - name: Generate test brewfile
        shell: zsh {0}
        run: |
          echo "
            brew \"git\"
            brew \"asdf\"
            brew \"curl\"
            brew \"git-town\"
            brew \"pure\"
            brew \"stow\"
            brew \"libyaml\"
            brew \"readline\"
            brew \"gmp\"
          " > ~/.dotfiles/.brewfile

      - name: Run fresh setup
        shell: zsh {0}
        run: |
          cd ~/.dotfiles
          ./scripts/fresh.sh

      - name: Check if fresh setup completed successfully
        shell: zsh {0}
        run: |
          set -e

          source ~/.zshrc

          echo "=== Core tools ==="
          brew --version
          git --version
          stow --version
          asdf --version

          echo "=== Stowed dotfiles (symlinks in HOME) ==="
          test -L ~/.zshrc && test -f ~/.zshrc && echo "  .zshrc OK"
          test -L ~/.zprofile && test -f ~/.zprofile && echo "  .zprofile OK"
          test -L ~/.gitconfig && test -f ~/.gitconfig && echo "  .gitconfig OK"
          test -L ~/.brewfile && test -f ~/.brewfile && echo "  .brewfile OK"

          echo "=== Homebrew ==="
          brew bundle check
          brew list --version

          echo "=== ASDF runtimes ==="
          node --version
          ruby --version

          echo "=== Oh My Zsh ==="
          test -d ~/.oh-my-zsh && echo "  Oh My Zsh installed"

          echo "=== macOS defaults (from setup_macos) ==="
          test "$(defaults read NSGlobalDomain AppleLocale)" = "en_US@currency=EUR"
          test "$(defaults read NSGlobalDomain AppleMeasurementUnits)" = "Centimeters"

          echo "âœ… Fresh setup verification passed"
